<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Flipbook</title>

  <!-- External CSS -->
  <link rel="stylesheet" href="flipbookstyles.css" />
</head>

<body>

  <div id="wrap" aria-label="Flipbook">
    <div id="flipbook"></div>

    <div class="toolbar" id="toolbar">
      <button id="prev" class="opal-btn" type="button" aria-label="Previous page">
        <span class="icon">‚Üê</span><span class="label">Prev</span>
      </button>

      <div class="status" id="status">Page 1 / 30</div>

      <button id="next" class="opal-btn primary" type="button" aria-label="Next page">
        <span class="label">Next</span><span class="icon">‚Üí</span>
      </button>

      <!-- Mute toggle (new) -->
      <button id="mute" class="opal-btn icon-only" type="button" aria-label="Mute sound" title="Mute sound">
        <span class="icon" id="muteIcon">üîä</span>
      </button>

      <!-- Fullscreen toggle -->
      <button id="fs" class="opal-btn icon-only" type="button" aria-label="Enter fullscreen" title="Fullscreen (F)">
        <span class="icon" id="fsIcon">‚õ∂</span>
      </button>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/turn.js/3/turn.min.js"></script>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const TOTAL_PAGES = 30;

      const wrap = document.getElementById("wrap");
      const flipbook = document.getElementById("flipbook");

      const toolbar = document.getElementById("toolbar");
      const status = document.getElementById("status");
      const prevBtn = document.getElementById("prev");
      const nextBtn = document.getElementById("next");

      const fsBtn = document.getElementById("fs");
      const fsIcon = document.getElementById("fsIcon");

      const muteBtn = document.getElementById("mute");
      const muteIcon = document.getElementById("muteIcon");

      // ---------------------------
      // Sound state + persistence
      // ---------------------------
      let soundOn = localStorage.getItem("flipbook_sound") !== "off";
      function updateMuteUI() {
        muteIcon.textContent = soundOn ? "üîä" : "üîá";
        muteBtn.setAttribute("aria-label", soundOn ? "Mute sound" : "Unmute sound");
        muteBtn.title = soundOn ? "Mute sound" : "Unmute sound";
      }
      updateMuteUI();

      muteBtn.addEventListener("click", () => {
        soundOn = !soundOn;
        localStorage.setItem("flipbook_sound", soundOn ? "on" : "off");
        updateMuteUI();
      });

      // ---------------------------
      // Page flip sound (sound/page.mp3)
      // ---------------------------
      const pageSound = new Audio("sound/page.mp3");
      pageSound.preload = "auto";
      pageSound.volume = 0.35;

      // Unlock audio after first user gesture (autoplay restrictions)
      let audioUnlocked = false;
      function unlockAudioOnce() {
        if (audioUnlocked) return;
        audioUnlocked = true;

        const originalVol = pageSound.volume;
        pageSound.volume = 0; // silent unlock
        pageSound.play().then(() => {
          pageSound.pause();
          pageSound.currentTime = 0;
          pageSound.volume = originalVol;
        }).catch(() => {
          pageSound.volume = originalVol;
        });
      }
      window.addEventListener("pointerdown", unlockAudioOnce, { once: true });
      window.addEventListener("keydown", unlockAudioOnce, { once: true });

      let lastSoundAt = 0;
      function playPageSound() {
        if (!soundOn) return;

        const now = Date.now();
        if (now - lastSoundAt < 90) return; // prevents double-firing
        lastSoundAt = now;

        try {
          pageSound.currentTime = 0;
          pageSound.play().catch(() => {});
        } catch (e) {
          // ignore
        }
      }

      // Build pages (page-01.png ... page-30.png)
      for (let i = 1; i <= TOTAL_PAGES; i++) {
        const page = document.createElement("div");
        page.className = "page";

        const img = document.createElement("img");
        img.loading = "lazy";
        img.src = `pages/page-${String(i).padStart(2, "0")}.png`;
        img.alt = `Page ${i}`;

        page.appendChild(img);
        flipbook.appendChild(page);
      }

      // Init turn.js
      $("#flipbook").turn({
        width: wrap.clientWidth,
        height: wrap.clientHeight,
        autoCenter: true
      });

      function resizeBook(){
        $("#flipbook").turn("size", wrap.clientWidth, wrap.clientHeight);
      }
      window.addEventListener("resize", resizeBook);

      // Status + enable/disable ends
      function updateUI() {
        const p = $("#flipbook").turn("page");
        status.textContent = `Page ${p} / ${TOTAL_PAGES}`;
        prevBtn.disabled = (p <= 1);
        nextBtn.disabled = (p >= TOTAL_PAGES);
      }
      $("#flipbook").bind("turned", updateUI);
      updateUI();

      // Play sound when a page turn starts (best ‚Äúpaper flip‚Äù feel)
      $("#flipbook").bind("turning", playPageSound);

      // Controls
      prevBtn.onclick = () => $("#flipbook").turn("previous");
      nextBtn.onclick = () => $("#flipbook").turn("next");

      // Fullscreen toggle
      function isFullscreen() {
        return document.fullscreenElement === wrap || document.webkitFullscreenElement === wrap;
      }

      async function enterFullscreen() {
        try {
          if (wrap.requestFullscreen) await wrap.requestFullscreen();
          else if (wrap.webkitRequestFullscreen) wrap.webkitRequestFullscreen();
        } catch (e) {
          console.warn("Fullscreen request failed:", e);
        }
      }

      async function exitFullscreen() {
        try {
          if (document.exitFullscreen) await document.exitFullscreen();
          else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
        } catch (e) {
          console.warn("Exit fullscreen failed:", e);
        }
      }

      async function toggleFullscreen() {
        if (isFullscreen()) await exitFullscreen();
        else await enterFullscreen();
      }

      function updateFsUI() {
        const on = isFullscreen();
        fsIcon.textContent = on ? "‚úï" : "‚õ∂";
        fsBtn.setAttribute("aria-label", on ? "Exit fullscreen" : "Enter fullscreen");
        fsBtn.title = on ? "Exit fullscreen (Esc)" : "Fullscreen (F)";
        setTimeout(resizeBook, 60);
      }

      fsBtn.addEventListener("click", toggleFullscreen);
      document.addEventListener("fullscreenchange", updateFsUI);
      document.addEventListener("webkitfullscreenchange", updateFsUI);
      updateFsUI();

      // Tap-to-show/hide toolbar
      const isTouch =
        ("ontouchstart" in window) ||
        (navigator.maxTouchPoints && navigator.maxTouchPoints > 0);

      let hideTimer = null;

      function showToolbar(autoHide = true) {
        toolbar.classList.remove("hidden");

        if (!isTouch) return; // desktop: keep it visible

        if (hideTimer) clearTimeout(hideTimer);
        if (autoHide) {
          hideTimer = setTimeout(() => {
            toolbar.classList.add("hidden");
          }, 2200);
        }
      }

      function toggleToolbar() {
        if (!isTouch) {
          toolbar.classList.toggle("hidden");
          return;
        }

        const willShow = toolbar.classList.contains("hidden");
        toolbar.classList.toggle("hidden");
        if (willShow) showToolbar(true);
        else if (hideTimer) { clearTimeout(hideTimer); hideTimer = null; }
      }

      wrap.addEventListener("pointerup", (e) => {
        if (e.target.closest(".toolbar")) return;
        toggleToolbar();
      });

      toolbar.addEventListener("pointerdown", () => showToolbar(true), { passive: true });
      $("#flipbook").bind("turning", () => showToolbar(true));
      showToolbar(true);

      // Keyboard shortcuts
      window.addEventListener("keydown", (e) => {
        if (e.key === "ArrowLeft") $("#flipbook").turn("previous");
        if (e.key === "ArrowRight") $("#flipbook").turn("next");
        if (e.key.toLowerCase() === "f") toggleFullscreen();
        if (e.key.toLowerCase() === "h") toggleToolbar();
        if (e.key.toLowerCase() === "m") muteBtn.click(); // bonus: M toggles mute
      });
    });
  </script>

</body>
</html>
